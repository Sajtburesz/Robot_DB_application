#!/bin/bash
set -e

# Perform all operations using the default postgres user
psql -v ON_ERROR_STOP=1 --username "postgres" <<-EOSQL
    CREATE DATABASE "$NEW_DB_NAME";
    CREATE USER "$NEW_DB_USER" WITH PASSWORD '$NEW_DB_PASSWORD';
    GRANT ALL PRIVILEGES ON DATABASE "$NEW_DB_NAME" TO "$NEW_DB_USER";
    \c "$NEW_DB_NAME"
    GRANT USAGE ON SCHEMA public TO "$NEW_DB_USER";
    GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO "$NEW_DB_USER";
    GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO "$NEW_DB_USER";
    GRANT ALL PRIVILEGES ON ALL FUNCTIONS IN SCHEMA public TO "$NEW_DB_USER";
    ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO "$NEW_DB_USER";
    ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO "$NEW_DB_USER";
    ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON FUNCTIONS TO "$NEW_DB_USER";
    GRANT CREATE ON SCHEMA public TO "$NEW_DB_USER";
EOSQL